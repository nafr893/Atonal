{% if product.metafields.custom.selected_variant == true or product.metafields.custom.selected_variant == null %}
  {% assign variant_gallery = product.selected_or_first_available_variant.metafields.custom.variant_gallery.value %}
  {% if variant_gallery %}
    <script id="VariantGalleryJSON" type="application/json">
      {{ variant_gallery | json }}
    </script>
  {% endif %}

  <style>
    .hidden {
      display: none !important;
      opacity: 0;
    }
    [data-media-id], .media-item, .thumbnail, .product-media-container, .slideshow-slide, .media-gallery__grid li, .slideshow-controls__dots li {
      opacity: 1;
    }
    .media-gallery[data-variant-images-initialized="true"] .slideshow-slide,
    .media-gallery[data-variant-images-initialized="true"] .slideshow-controls__dots li,
    .media-gallery[data-variant-images-initialized="true"] .thumbnail,
    .media-gallery[data-variant-images-initialized="true"] .dialog-thumbnails-list__thumbnail {
      display: block;
    }
  </style>

  <script>
    (function() {
      let lastSelectedColor = null;
      const metafieldGalleryJSON = document.getElementById('VariantGalleryJSON');
      const variantGalleryImages = metafieldGalleryJSON ? JSON.parse(metafieldGalleryJSON.textContent) : [];

      function updateVariantImages(selectedColor, mediaGallery) {
        if (!mediaGallery) return;
        mediaGallery.innerHTML = '';

        if (!variantGalleryImages || variantGalleryImages.length === 0) {
          console.warn('No variant metafield images found.');
          return;
        }

        variantGalleryImages.forEach((imageObj, index) => {
          const imageUrl = typeof imageObj === 'object' && imageObj.image ? imageObj.image : imageObj;
          const imageAlt = selectedColor ? selectedColor : `Variant Image ${index + 1}`;

          const wrapper = document.createElement('div');
          wrapper.className = 'product__media-item';
          wrapper.style.display = 'block';

          const img = document.createElement('img');
          img.src = imageUrl;
          img.alt = imageAlt;
          img.loading = 'lazy';

          wrapper.appendChild(img);
          mediaGallery.appendChild(wrapper);
        });

        mediaGallery.setAttribute('data-variant-images-initialized', 'true');
      }

      function initVariantImages() {
        const mediaGallery = document.querySelector('[data-product-media-gallery], media-gallery, .product__media, .product-media, .media-container, [data-product-media]');
        const productSection = document.querySelector('[data-product-id], .product-variant-id, .product-form, .product__form, [data-product-form], .product__info-container');

        if (!mediaGallery || !productSection) {
          console.error('Selected Variant Image: Required elements not found.');
          return;
        }

        const showVariantImage = () => {
          let selectedColor = null;
          const variantSelects = document.querySelector('[data-variant-selects], variant-selects, .variant-picker, .product-form__variants, .product__variants, [data-product-variants], .product__variant-options');

          if (variantSelects) {
            const currentValues = Array.from(
              variantSelects.querySelectorAll('select option[selected], input:checked, [data-variant-option][aria-selected="true"], [data-variant-option].is-selected, [data-variant-option][class*="selected"]')
            ).map(el => el.value || el.getAttribute('data-variant-option') || el.textContent.trim());

            selectedColor = currentValues.find(value => typeof value === 'string');
          }

          if (selectedColor === lastSelectedColor) return;
          lastSelectedColor = selectedColor;

          updateVariantImages(selectedColor, mediaGallery);
        };

        showVariantImage();

        productSection.addEventListener('change', showVariantImage);
        productSection.addEventListener('variant:change', showVariantImage);
        productSection.addEventListener('shopify:variant:change', showVariantImage);
        productSection.addEventListener('product:variant-updated', showVariantImage);
      }

      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        initVariantImages();
      } else {
        document.addEventListener('DOMContentLoaded', initVariantImages);
      }

      const observerTarget = document.querySelector('[data-product-id]') || document.body;
      const observer = new MutationObserver((mutationsList) => {
        for (const mutation of mutationsList) {
          if (mutation.type === 'childList') {
            const mediaGallery = document.querySelector('[data-product-media-gallery], media-gallery, .product__media, .product-media, .media-container, [data-product-media]');
            if (mediaGallery && !mediaGallery.hasAttribute('data-variant-images-initialized')) {
              mediaGallery.setAttribute('data-variant-images-initialized', 'true');
              initVariantImages();
              break;
            }
          }
        }
      });
      observer.observe(observerTarget, { childList: true, subtree: true });
    })();
  </script>
{% endif %}

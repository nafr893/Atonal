{% if product.metafields.custom.selected_variant == true or product.metafields.custom.selected_variant == null %}
  {% assign variant_gallery = product.selected_or_first_available_variant.metafields.custom.variant_gallery.value %}
  {% if variant_gallery %}
    <script id="VariantGalleryJSON" type="application/json">
      {{ variant_gallery | json }}
    </script>
  {% endif %}

  <style>
    .hidden {
      display: none !important;
      opacity: 0;
    }
    [data-media-id], .media-item, .thumbnail, .product-media-container, .slideshow-slide, .media-gallery__grid li, .slideshow-controls__dots li {
      opacity: 1;
    }
    .media-gallery[data-variant-images-initialized="true"] .slideshow-slide,
    .media-gallery[data-variant-images-initialized="true"] .slideshow-controls__dots li,
    .media-gallery[data-variant-images-initialized="true"] .thumbnail,
    .media-gallery[data-variant-images-initialized="true"] .dialog-thumbnails-list__thumbnail {
      display: block;
    }
  </style>

  <script>
    (function() {
      const metafieldGalleryJSON = document.getElementById('VariantGalleryJSON');
      const variantGalleryImages = metafieldGalleryJSON ? JSON.parse(metafieldGalleryJSON.textContent) : [];

      function updateVariantImages(variant) {
        // Only proceed if we have variant gallery images for this variant
        if (!variant?.metafields?.custom?.variant_gallery?.value) {
          return;
        }

        const mediaGallery = document.querySelector('media-gallery');
        const slideshow = mediaGallery?.querySelector('slideshow-component');
        
        if (!slideshow) {
          console.log('No slideshow found');
          return;
        }

        const variantImages = variant.metafields.custom.variant_gallery.value;
        const slideshowContainer = slideshow.querySelector('slideshow-container');
        
        if (slideshowContainer) {
          // Clear existing slides
          slideshowContainer.innerHTML = '';
          
          // Add variant images
          variantImages.forEach((imageObj, index) => {
            const slide = document.createElement('div');
            slide.className = 'slideshow-slide product-media-container product-media-container--image';
            slide.setAttribute('data-media-id', imageObj.id || index);
            
            const mediaDiv = document.createElement('div');
            mediaDiv.className = 'product-media';
            mediaDiv.style.setProperty('--ratio', '1');
            
            const img = document.createElement('img');
            img.src = imageObj.src || imageObj;
            img.alt = imageObj.alt || '';
            img.className = 'product-media__image';
            img.loading = index === 0 ? 'eager' : 'lazy';
            
            mediaDiv.appendChild(img);
            slide.appendChild(mediaDiv);
            slideshowContainer.appendChild(slide);
          });
          
          // Reset slideshow to first slide
          if (slideshow.select) {
            slideshow.select(0);
          }
        }
      }

      // Listen for variant update events
      document.addEventListener('variant:update', (event) => {
        const variant = event.detail?.resource;
        if (variant) {
          updateVariantImages(variant);
        }
      });

      // Initialize on page load
      function init() {
        const variantPicker = document.querySelector('variant-picker');
        if (variantPicker) {
          const variantScript = document.querySelector('variant-picker script[type="application/json"]');
          if (variantScript) {
            try {
              const variantData = JSON.parse(variantScript.textContent);
              updateVariantImages(variantData);
            } catch (e) {
              console.error('Error parsing variant data:', e);
            }
          }
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
{% endif %}
